<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Axio - Testes</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link href="https://fonts.gstatic.com" crossorigin rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Theme CSS -->
  <link href="../css/themes/theme-light.css" rel="stylesheet" />
  <link href="../css/themes/theme-dark.css" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 2rem;
      background: var(--md-sys-color-background);
      color: var(--md-sys-color-on-background);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .test-page-header {
      position: relative;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
      gap: 0.75rem;
    }

    .language-selector,
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 999px;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface);
      color: var(--md-sys-color-on-surface);
      font: 400 0.875rem/1.25rem 'Roboto', sans-serif;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background-color 0.15s ease;
    }

    .language-selector::before,
    .theme-toggle::before {
      content: "";
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }

    .language-selector:hover::before,
    .theme-toggle:hover::before {
      opacity: 0.08;
    }

    .language-selector:focus-visible::before,
    .theme-toggle:focus-visible::before {
      opacity: 0.12;
      outline: 2px solid var(--md-sys-color-primary);
      outline-offset: -2px;
    }

    .language-selector__text {
      font-weight: 500;
    }

    .language-selector__icon {
      fill: currentColor;
      transition: transform 0.15s ease;
    }

    .language-selector[aria-expanded="true"] .language-selector__icon {
      transform: rotate(180deg);
    }

    .theme-toggle {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      justify-content: center;
    }

    .theme-toggle__icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .theme-toggle__icon svg {
      width: 24px;
      height: 24px;
      display: block;
    }

    .theme-toggle--dark .theme-toggle__icon--light {
      opacity: 1;
    }

    .theme-toggle--light .theme-toggle__icon--dark {
      opacity: 1;
    }

    .language-menu {
      position: fixed;
      z-index: 1500;
      min-width: 8rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--md-sys-color-outline-variant);
      background: var(--md-sys-color-surface-container);
      box-shadow: 0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.3);
      animation: menu-fade-in 0.15s ease;
    }

    @keyframes menu-fade-in {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .language-menu__item {
      display: block;
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      border-radius: 0.25rem;
      color: var(--md-sys-color-on-surface);
      font: 400 0.875rem/1.25rem 'Roboto', sans-serif;
      text-align: left;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background-color 0.15s ease;
    }

    .language-menu__item::before {
      content: "";
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }

    .language-menu__item:hover::before {
      opacity: 0.08;
    }

    .language-menu__item--active {
      color: var(--md-sys-color-primary);
      font-weight: 500;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--md-sys-color-surface);
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    h1 {
      margin-bottom: 1rem;
      color: var(--md-sys-color-primary);
      font: 400 2rem/2.5rem 'Roboto', sans-serif;
    }

    .test-results {
      margin-top: 2rem;
    }

    .test-results h2 {
      margin-bottom: 1.5rem;
      color: var(--md-sys-color-on-surface);
      border-bottom: 2px solid var(--md-sys-color-primary);
      padding-bottom: 0.5rem;
      font: 400 1.5rem/2rem 'Roboto', sans-serif;
    }

    .test-category {
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--md-sys-color-surface-variant);
      border-radius: 0.5rem;
      border: 1px solid var(--md-sys-color-outline-variant);
      transition: background-color 0.3s ease;
    }

    .test-category-title {
      margin-bottom: 0.5rem;
      color: var(--md-sys-color-primary);
      font-size: 1.2rem;
      font-weight: 500;
    }

    .test-category-summary {
      margin-bottom: 1rem;
      color: var(--md-sys-color-on-surface-variant);
      font-size: 0.9rem;
      font-weight: 400;
    }

    .test-result {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      border-left: 4px solid;
      transition: background-color 0.2s ease;
    }

    .test-result.test-passed {
      background: var(--md-sys-color-primary-container);
      border-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary-container);
    }

    .test-result.test-failed {
      background: var(--md-sys-color-error-container);
      border-color: var(--md-sys-color-error);
      color: var(--md-sys-color-on-error-container);
    }

    .test-icon {
      font-weight: bold;
      margin-right: 0.75rem;
      font-size: 1.2rem;
    }

    .test-passed .test-icon {
      color: var(--md-sys-color-primary);
    }

    .test-failed .test-icon {
      color: var(--md-sys-color-error);
    }

    .test-name {
      flex: 1;
      font-weight: 400;
    }

    .test-error {
      margin-top: 0.5rem;
      margin-left: 2rem;
      color: var(--md-sys-color-error);
      font-size: 0.9rem;
      font-family: 'Courier New', monospace;
    }

    .test-summary {
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--md-sys-color-surface-variant);
      border-radius: 0.5rem;
      text-align: center;
      transition: background-color 0.3s ease;
    }

    .test-summary strong {
      font-size: 1.1rem;
      color: var(--md-sys-color-on-surface);
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border: none;
      border-radius: 0.5rem;
      font: 500 0.875rem/1.25rem 'Roboto', sans-serif;
      cursor: pointer;
      margin-top: 1rem;
      transition: background-color 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: "";
      position: absolute;
      inset: 0;
      background: currentColor;
      opacity: 0;
      transition: opacity 0.15s ease;
      pointer-events: none;
    }

    button:hover::before {
      opacity: 0.08;
    }

    button:disabled {
      background: var(--md-sys-color-surface-variant);
      color: var(--md-sys-color-on-surface-variant);
      cursor: not-allowed;
    }

    #test-output {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--md-sys-color-surface-variant);
      border-radius: 0.5rem;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      color: var(--md-sys-color-on-surface-variant);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="test-page-header">
      <button class="language-selector" id="language-selector" type="button" aria-label="Select language"
        aria-haspopup="true" aria-expanded="false">
        <span class="language-selector__text" id="language-selector-text">PT</span>
        <svg class="language-selector__icon" viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M7 10l5 5 5-5z" />
        </svg>
      </button>

      <button class="theme-toggle theme-toggle--light" id="theme-toggle" type="button" aria-label="Toggle theme"
        aria-pressed="false">
        <svg class="theme-toggle__icon theme-toggle__icon--light" viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor"
            d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0a.996.996 0 000-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
        </svg>
        <svg class="theme-toggle__icon theme-toggle__icon--dark" viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor"
            d="M12 3a9 9 0 109 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 01-4.4 2.26 5.403 5.403 0 01-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />
        </svg>
      </button>
    </div>

    <h1 id="test-page-title">üß™ Testes - Axio</h1>
    <p id="test-page-description">Execute os testes unit√°rios e de integra√ß√£o para verificar o funcionamento dos m√≥dulos
      e fluxos completos da aplica√ß√£o.</p>

    <button id="run-tests">Executar Testes</button>

    <div id="test-output"></div>
    <div id="test-results"></div>
  </div>

  <script type="module">
    import { initI18n, setLanguage, getLanguage, t, getAvailableLanguages } from "../js/modules/i18n.js";

    let runner, output, resultsDiv;
    let logOutput = "";
    let currentTheme = "light";
    let languageMenu = null;

    // Initialize i18n
    initI18n();
    const updateTexts = () => {
      const pageTitle = document.getElementById("test-page-title");
      const pageDescription = document.getElementById("test-page-description");
      const runButton = document.getElementById("run-tests");
      const languageSelector = document.getElementById("language-selector");
      const languageSelectorText = document.getElementById("language-selector-text");
      const themeToggle = document.getElementById("theme-toggle");

      if (pageTitle) pageTitle.textContent = `üß™ ${t("testPageTitle")} - Axio`;
      if (pageDescription) pageDescription.textContent = t("testPageDescription");
      if (runButton) runButton.textContent = t("runTests");
      if (languageSelector) languageSelector.setAttribute("aria-label", t("ariaLanguageSelector"));
      if (languageSelectorText) {
        const lang = getLanguage();
        languageSelectorText.textContent = lang.toUpperCase();
      }
      if (themeToggle) themeToggle.setAttribute("aria-label", t("ariaThemeToggle"));
    };

    // Theme management
    const THEME_STORAGE_KEY = "todo-theme";
    const loadTheme = () => {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      currentTheme = stored === "dark" ? "dark" : "light";
      document.documentElement.dataset.theme = currentTheme;
      updateThemeToggle();
    };

    const updateThemeToggle = () => {
      const toggle = document.getElementById("theme-toggle");
      if (!toggle) return;
      const isDark = currentTheme === "dark";
      toggle.classList.toggle("theme-toggle--dark", isDark);
      toggle.classList.toggle("theme-toggle--light", !isDark);
      toggle.setAttribute("aria-pressed", String(isDark));
    };

    const toggleTheme = () => {
      currentTheme = currentTheme === "dark" ? "light" : "dark";
      document.documentElement.dataset.theme = currentTheme;
      localStorage.setItem(THEME_STORAGE_KEY, currentTheme);
      updateThemeToggle();
    };

    // Language menu
    const closeLanguageMenu = () => {
      if (languageMenu) {
        languageMenu.remove();
        languageMenu = null;
      }
      const selector = document.getElementById("language-selector");
      if (selector) selector.setAttribute("aria-expanded", "false");
    };

    const createLanguageMenu = () => {
      closeLanguageMenu();
      const menu = document.createElement("div");
      menu.classList.add("language-menu");
      menu.setAttribute("role", "menu");
      menu.setAttribute("aria-label", t("ariaLanguageSelector"));

      const languages = [
        { code: "pt", name: t("languagePortuguese") },
        { code: "en", name: t("languageEnglish") },
      ];

      languages.forEach((lang) => {
        const item = document.createElement("button");
        item.classList.add("language-menu__item");
        if (getLanguage() === lang.code) {
          item.classList.add("language-menu__item--active");
        }
        item.setAttribute("role", "menuitem");
        item.textContent = lang.name;

        item.addEventListener("click", () => {
          setLanguage(lang.code);
          updateTexts();
          if (runner) {
            resultsDiv.innerHTML = runner.getResultsHTML(t);
          }
          closeLanguageMenu();
        });

        menu.append(item);
      });

      const selector = document.getElementById("language-selector");
      const rect = selector.getBoundingClientRect();
      menu.style.position = "fixed";
      menu.style.top = `${rect.bottom + 4}px`;
      menu.style.right = `${window.innerWidth - rect.right}px`;

      document.body.append(menu);
      languageMenu = menu;
      selector.setAttribute("aria-expanded", "true");

      setTimeout(() => {
        const handleClickOutside = (event) => {
          if (!menu.contains(event.target) && event.target !== selector) {
            closeLanguageMenu();
            document.removeEventListener("click", handleClickOutside);
          }
        };
        document.addEventListener("click", handleClickOutside);
      }, 0);
    };

    // Override console.log to capture output
    const originalLog = console.log;
    const originalError = console.error;

    console.log = (...args) => {
      logOutput += args.join(" ") + "\n";
      originalLog(...args);
    };

    console.error = (...args) => {
      logOutput += args.join(" ") + "\n";
      originalError(...args);
    };

    async function initTests() {
      try {
        const TestRunnerModule = await import("./test-runner.js");
        const TestRunner = TestRunnerModule.default || TestRunnerModule.TestRunner;

        const { runStorageTests } = await import("./storage.test.js");
        const { runTodoTests } = await import("./todo.test.js");
        const { runI18nTests } = await import("./i18n.test.js");
        const { runKeyboardTests } = await import("./keyboard.test.js");
        const { runIntegrationTests } = await import("./integration.test.js");

        runner = new TestRunner();
        output = document.getElementById("test-output");
        resultsDiv = document.getElementById("test-results");

        document.getElementById("run-tests").addEventListener("click", async () => {
          try {
            logOutput = "";
            resultsDiv.innerHTML = "";
            output.textContent = `${t("executingTests")}\n\n`;

            runner = new TestRunner();

            try {
              runStorageTests(runner);
            } catch (error) {
              console.error("Erro ao registrar testes de storage:", error);
              output.textContent += `${t("errorRegisteringTests", "Error registering tests")} (Storage): ${error.message}\n`;
            }

            try {
              runTodoTests(runner);
            } catch (error) {
              console.error("Erro ao registrar testes de todo:", error);
              output.textContent += `${t("errorRegisteringTests", "Error registering tests")} (Todo): ${error.message}\n`;
            }

            try {
              runI18nTests(runner);
            } catch (error) {
              console.error("Erro ao registrar testes de i18n:", error);
              output.textContent += `${t("errorRegisteringTests", "Error registering tests")} (i18n): ${error.message}\n`;
            }

            try {
              runKeyboardTests(runner);
            } catch (error) {
              console.error("Erro ao registrar testes de keyboard:", error);
              output.textContent += `${t("errorRegisteringTests", "Error registering tests")} (Keyboard): ${error.message}\n`;
            }

            try {
              runIntegrationTests(runner);
            } catch (error) {
              console.error("Erro ao registrar testes de integra√ß√£o:", error);
              output.textContent += `${t("errorRegisteringTests", "Error registering tests")} (Integration): ${error.message}\n`;
            }

            try {
              await runner.run();
            } catch (error) {
              console.error("Erro ao executar testes:", error);
              output.textContent += `${t("errorRunningTests")}: ${error.message}\n`;
            }

            output.textContent = logOutput || output.textContent || t("noOutputCaptured");
            resultsDiv.innerHTML = runner.getResultsHTML(t);
          } catch (error) {
            console.error("Erro geral:", error);
            output.textContent = `${t("errorRunningTests")}: ${error.message}\n\n${error.stack || ""}`;
            resultsDiv.innerHTML = `<div class="test-result test-failed"><span class="test-icon">‚úó</span><span class="test-name">${t("errorRunningTests")}</span><div class="test-error">${error.message}</div></div>`;
          }
        });

        // Theme toggle
        document.getElementById("theme-toggle")?.addEventListener("click", toggleTheme);

        // Language selector
        document.getElementById("language-selector")?.addEventListener("click", (event) => {
          event.stopPropagation();
          if (languageMenu) {
            closeLanguageMenu();
          } else {
            createLanguageMenu();
          }
        });

        // Close language menu on Escape
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && languageMenu) {
            closeLanguageMenu();
          }
        });

        // Initial updates
        loadTheme();
        updateTexts();
      } catch (error) {
        console.error("Erro ao carregar m√≥dulos:", error);
        const errorMsg = typeof t === "function" ? t("errorLoadingModules") : "Error loading modules";
        const httpMsg = typeof t === "function" ? t("ensureHttpServer") : "Make sure you are running on an HTTP server (not file://)";
        document.getElementById("test-output").textContent = `${errorMsg}: ${error.message}\n\n${error.stack || ""}\n\n${httpMsg}`;
        document.getElementById("run-tests").disabled = true;
      }
    }

    initTests();
  </script>
</body>

</html>